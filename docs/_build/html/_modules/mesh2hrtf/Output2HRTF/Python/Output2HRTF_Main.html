
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mesh2hrtf.Output2HRTF.Python.Output2HRTF_Main &#8212; Mesh2HRTF 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/insipid.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script defer src="../../../../_static/insipid.js"></script>
    <script defer src="../../../../_static/insipid-sidebar.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
  </head>
  <body class="sidebar-visible">
    <script type="text/javascript">
        (function() {
            var $body = $(document.body);
            $body.addClass('js');
            $body.addClass('sidebar-resizing');  // avoid transitions on load
            $body.removeClass('sidebar-visible');
            try {
                var sidebar = localStorage.getItem('sphinx-sidebar');
                if (sidebar === 'visible') {
                    $body.addClass('sidebar-visible');
                }
                var sidebar_width = localStorage.getItem('sphinx-sidebar-width');
                if (sidebar_width) {
                    $(':root').css('--sidebar-width', sidebar_width);
                }
            } catch(e) {
            }
        })();
    </script>
    <header id="topbar-placeholder">
      <div id="topbar">
        <div id="titlebar">
          <div class="buttons">
            <button id="sidebar-button" type="button" aria-controls="sphinxsidebar" accesskey="M">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg>
            </button>
            <button id="search-button" type="button" title="Search" aria-label="Search" aria-expanded="false" aria-controls="search-form" accesskey="S">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
            </button>
          </div>
          <div class="title">
            <a class="parent" href="../../../index.html" accesskey="U">Module code</a>
            <a class="top" href="#">mesh2hrtf.Output2HRTF.Python.Output2HRTF_Main</a>
          </div>
          <div class="buttons">
            <button id="fullscreen-button" type="button" aria-hidden="true">
              <span class="enable">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M212.686 315.314L120 408l32.922 31.029c15.12 15.12 4.412 40.971-16.97 40.971h-112C10.697 480 0 469.255 0 456V344c0-21.382 25.803-32.09 40.922-16.971L72 360l92.686-92.686c6.248-6.248 16.379-6.248 22.627 0l25.373 25.373c6.249 6.248 6.249 16.378 0 22.627zm22.628-118.628L328 104l-32.922-31.029C279.958 57.851 290.666 32 312.048 32h112C437.303 32 448 42.745 448 56v112c0 21.382-25.803 32.09-40.922 16.971L376 152l-92.686 92.686c-6.248 6.248-16.379 6.248-22.627 0l-25.373-25.373c-6.249-6.248-6.249-16.378 0-22.627z"/></svg>
              </span>
              <span class="disable">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M4.686 427.314L104 328l-32.922-31.029C55.958 281.851 66.666 256 88.048 256h112C213.303 256 224 266.745 224 280v112c0 21.382-25.803 32.09-40.922 16.971L152 376l-99.314 99.314c-6.248 6.248-16.379 6.248-22.627 0L4.686 449.941c-6.248-6.248-6.248-16.379 0-22.627zM443.314 84.686L344 184l32.922 31.029c15.12 15.12 4.412 40.971-16.97 40.971h-112C234.697 256 224 245.255 224 232V120c0-21.382 25.803-32.09 40.922-16.971L296 136l99.314-99.314c6.248-6.248 16.379-6.248 22.627 0l25.373 25.373c6.248 6.248 6.248 16.379 0 22.627z"/></svg>
              </span>
            </button>
          </div>
        </div>
        <div id="searchbox" role="search">
          <form id="search-form" class="search" style="display: none" action="../../../../search.html" method="get">
            <input type="search" name="q" placeholder="Search ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            <button>Go</button>
          </form>
        </div>
      </div>
    </header>
    <nav>
    </nav>

    <nav class="relbar">
    </nav>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
<h1>Source code for mesh2hrtf.Output2HRTF.Python.Output2HRTF_Main</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Python tools for Mesh2HRTF including functions to generate SOFA files</span>
<span class="sd">containing the HRTF/HRIR data, merge SOFA files containing data for the left</span>
<span class="sd">and right ear and generate evaluation grids.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">Delaunay</span><span class="p">,</span> <span class="n">ConvexHull</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">import</span> <span class="nn">sofar</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">import</span> <span class="nn">pyfar</span> <span class="k">as</span> <span class="nn">pf</span>


<div class="viewcode-block" id="Output2HRTF_Main"><a class="viewcode-back" href="../../../../mesh2hrtf.html#mesh2hrtf.Output2HRTF_Main">[docs]</a><span class="k">def</span> <span class="nf">Output2HRTF_Main</span><span class="p">(</span>
        <span class="n">Mesh2HRTF_version</span><span class="p">,</span> <span class="n">sourceType</span><span class="p">,</span> <span class="n">numSources</span><span class="p">,</span> <span class="n">sourceCenter</span><span class="p">,</span>
        <span class="n">sourceArea</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">computeHRIRs</span><span class="p">,</span> <span class="n">speedOfSound</span><span class="p">,</span> <span class="n">densityOfAir</span><span class="p">,</span>
        <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process NumCalc output and write data to disk.</span>

<span class="sd">    All parameters are written to Output2HRTF.py upon exporting a Mesh2HRTF</span>
<span class="sd">    project from Blender. This function will thus usually be called from an</span>
<span class="sd">    Output2HRTF.py file.</span>

<span class="sd">    Processing the data is done in the following steps</span>

<span class="sd">    1. use :py:func:`~project_report` to parse files in</span>
<span class="sd">       project_folder/NumCalc/source_*/NC*.out, write project report to</span>
<span class="sd">       project_folder/Output2HRTF/report_source_*.csv. Raise a warning if any</span>
<span class="sd">       issues were detected and write report_issues.txt to the same folder</span>
<span class="sd">    2. Read simulated pressures from project_folder/NumCalc/source_*/be.out.</span>
<span class="sd">       This and the following steps are done, even if an issue was detected in</span>
<span class="sd">       the previous step</span>
<span class="sd">    3. use :py:func:`~reference_hrtf` and :py:func:`~compute_hrir` to save the</span>
<span class="sd">       results to SOFA files</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Mesh2HRTF_version : string</span>
<span class="sd">        Mesh2HRTF version as string</span>
<span class="sd">    numSources : integer</span>
<span class="sd">        Number of sound sources in the simulation</span>
<span class="sd">    sourceType : string</span>
<span class="sd">        The source type (&#39;Both ears&#39;, &#39;Left ear&#39;, &#39;Right ear&#39;,</span>
<span class="sd">                         &#39;Point source&#39;, &#39;Plane wave&#39;)</span>
<span class="sd">    sourceCenter : array</span>
<span class="sd">        The source position</span>
<span class="sd">    sourceArea : array</span>
<span class="sd">        The area of the source(s) if using vibrating elements as sourceType.</span>
<span class="sd">        This is required for referencing the HRTFs. Use an area of 1 for a</span>
<span class="sd">        point source.</span>
<span class="sd">    reference : boolean</span>
<span class="sd">        Indicate if the HRTF are referenced to the pressure in the center of</span>
<span class="sd">        the head with the head absent.</span>
<span class="sd">    computeHRIRs : boolean</span>
<span class="sd">        Indicate if the HRIRs should be calculated by means of the inverse</span>
<span class="sd">        Fourier transform.</span>
<span class="sd">    speedOfSound : float</span>
<span class="sd">        The speed of sound in m/s</span>
<span class="sd">    densityOfAir : float</span>
<span class="sd">        The density of air in kg/m^3</span>
<span class="sd">    folder : str, optional</span>
<span class="sd">        The path of the Mesh2HRTF project folder, i.e., the folder containing</span>
<span class="sd">        the subfolders EvaluationsGrids, NumCalc, and ObjectMeshes. The</span>
<span class="sd">        default, ``None`` uses the current working directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check input</span>
    <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="c1"># output directory</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;Output2HRTF&#39;</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;Output2HRTF&#39;</span><span class="p">))</span>

    <span class="c1"># get the number of frequency steps</span>
    <span class="n">numFrequencies</span> <span class="o">=</span> <span class="n">_get_number_of_frequencies</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;Info.txt&#39;</span><span class="p">))</span>

    <span class="c1"># write the project report and check for issues</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Writing the project report ...&#39;</span><span class="p">)</span>
    <span class="n">found_issues</span><span class="p">,</span> <span class="n">report</span> <span class="o">=</span> <span class="n">project_report</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">found_issues</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>

    <span class="c1"># get the evaluation grids</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Loading the EvaluationGrids ...&#39;</span><span class="p">)</span>
    <span class="n">evaluationGrids</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_read_nodes_and_elements</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;EvaluationGrids&#39;</span><span class="p">))</span>

    <span class="c1"># get the object mesh</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Loading the ObjectMeshes ...&#39;</span><span class="p">)</span>
    <span class="n">objectMeshes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_read_nodes_and_elements</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;ObjectMeshes&#39;</span><span class="p">))</span>

    <span class="c1"># Load ObjectMesh data</span>
    <span class="n">pressure</span><span class="p">,</span> <span class="n">frequencies</span> <span class="o">=</span> <span class="n">_read_pressure</span><span class="p">(</span>
        <span class="n">numSources</span><span class="p">,</span> <span class="n">numFrequencies</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;pBoundary&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Saving ObjectMesh data ...&#39;</span><span class="p">)</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">mesh</span> <span class="ow">in</span> <span class="n">objectMeshes</span><span class="p">:</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="n">objectMeshes</span><span class="p">[</span><span class="n">mesh</span><span class="p">][</span><span class="s2">&quot;elements&quot;</span><span class="p">]</span>
        <span class="n">element_data</span> <span class="o">=</span> <span class="n">pressure</span>

        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pressure</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">element_data</span><span class="p">[:,</span> <span class="n">jj</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">element_data</span><span class="p">[</span>
                <span class="n">cnt</span><span class="p">:</span><span class="n">cnt</span><span class="o">+</span><span class="n">elements</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">jj</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;Output2HRTF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ObjectMesh_&quot;</span> <span class="o">+</span> <span class="n">mesh</span> <span class="o">+</span> <span class="s2">&quot;.npz&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span>
            <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">frequencies</span><span class="o">=</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="n">element_data</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="n">elements</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">del</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">element_data</span>

    <span class="c1"># Load EvaluationGrid data</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">evaluationGrids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Loading data for the evaluation grids ...&#39;</span><span class="p">)</span>

        <span class="n">pressure</span><span class="p">,</span> <span class="n">frequencies</span> <span class="o">=</span> <span class="n">_read_pressure</span><span class="p">(</span>
            <span class="n">numSources</span><span class="p">,</span> <span class="n">numFrequencies</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;pEvalGrid&#39;</span><span class="p">)</span>

    <span class="c1"># save to struct</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">evaluationGrids</span><span class="p">:</span>
        <span class="n">evaluationGrids</span><span class="p">[</span><span class="n">grid</span><span class="p">][</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pressure</span><span class="p">[</span>
            <span class="n">cnt</span><span class="p">:</span><span class="n">cnt</span><span class="o">+</span><span class="n">evaluationGrids</span><span class="p">[</span><span class="n">grid</span><span class="p">][</span><span class="s2">&quot;num_nodes&quot;</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="n">evaluationGrids</span><span class="p">[</span><span class="n">grid</span><span class="p">][</span><span class="s2">&quot;num_nodes&quot;</span><span class="p">]</span>

    <span class="k">del</span> <span class="n">grid</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">cnt</span>

    <span class="c1"># process BEM data for writing HRTFs and HRIRs to SOFA files</span>
    <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">evaluationGrids</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Saving HRTFs for EvaluationGrid &quot;</span><span class="si">{</span><span class="n">grid</span><span class="si">}</span><span class="s1">&quot; ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># get pressure as SOFA object (all following steps are run on SOFA</span>
        <span class="c1"># objects. This way they are available to other users as well)</span>
        <span class="n">sofa</span> <span class="o">=</span> <span class="n">_get_sofa_object</span><span class="p">(</span>
            <span class="n">evaluationGrids</span><span class="p">[</span><span class="n">grid</span><span class="p">][</span><span class="s2">&quot;pressure&quot;</span><span class="p">],</span>
            <span class="n">evaluationGrids</span><span class="p">[</span><span class="n">grid</span><span class="p">][</span><span class="s2">&quot;nodes&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="s2">&quot;cartesian&quot;</span><span class="p">,</span> <span class="n">sourceCenter</span><span class="p">,</span>
            <span class="s2">&quot;HRTF&quot;</span><span class="p">,</span> <span class="n">Mesh2HRTF_version</span><span class="p">,</span> <span class="n">frequencies</span><span class="o">=</span><span class="n">frequencies</span><span class="p">)</span>

        <span class="c1"># reference to sound pressure at the center of the head</span>
        <span class="k">if</span> <span class="n">reference</span><span class="p">:</span>
            <span class="n">sofa</span> <span class="o">=</span> <span class="n">reference_HRTF</span><span class="p">(</span><span class="n">sofa</span><span class="p">,</span> <span class="n">sourceType</span><span class="p">,</span> <span class="n">sourceArea</span><span class="p">,</span> <span class="n">speedOfSound</span><span class="p">,</span>
                                  <span class="n">densityOfAir</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>

        <span class="c1"># write HRTF data to SOFA file</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">write_sofa</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s1">&#39;Output2HRTF&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;HRTF_</span><span class="si">{</span><span class="n">grid</span><span class="si">}</span><span class="s1">.sofa&#39;</span><span class="p">),</span> <span class="n">sofa</span><span class="p">)</span>

        <span class="c1"># calculate and write HRIRs</span>
        <span class="k">if</span> <span class="n">computeHRIRs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reference</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Computing HRIRs requires prior referencing&quot;</span><span class="p">)</span>

            <span class="c1"># calculate shift value (equivalent to a 30 cm shift)</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sofa</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">n_shift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">.30</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">fs</span> <span class="o">*</span> <span class="n">speedOfSound</span><span class="p">)))</span>

            <span class="n">sofa</span> <span class="o">=</span> <span class="n">compute_HRIR</span><span class="p">(</span><span class="n">sofa</span><span class="p">,</span> <span class="n">n_shift</span><span class="p">)</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">write_sofa</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s1">&#39;Output2HRTF&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;HRIR_</span><span class="si">{</span><span class="n">grid</span><span class="si">}</span><span class="s1">.sofa&#39;</span><span class="p">),</span> <span class="n">sofa</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="reference_HRTF"><a class="viewcode-back" href="../../../../mesh2hrtf.html#mesh2hrtf.reference_HRTF">[docs]</a><span class="k">def</span> <span class="nf">reference_HRTF</span><span class="p">(</span><span class="n">sofa</span><span class="p">,</span> <span class="n">sourceType</span><span class="p">,</span> <span class="n">sourceArea</span><span class="p">,</span> <span class="n">speedOfSound</span><span class="p">,</span> <span class="n">densityOfAir</span><span class="p">,</span>
                   <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reference HRTF to the sound pressure in the center of the head. After</span>
<span class="sd">    referencing the sound pressure approaches 1 (0 dB) for low frequencies.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sofa : sofar Sofa object, str</span>
<span class="sd">       Sofa object containing the sound pressure or filename of a SOFA file to</span>
<span class="sd">       be loaded. SOFA object/file must be of the convention</span>
<span class="sd">       SimpleFreeFieldHRTF or GeneralTF</span>
<span class="sd">    sourceType : str</span>
<span class="sd">        The referencing depends on the source type used for simulating the</span>
<span class="sd">        sound pressure. Can be &quot;Both ears&quot;, &quot;Left ear&quot;, &quot;Right ear&quot;,</span>
<span class="sd">        &quot;Point source&quot;, or &quot;Plane wave&quot;</span>
<span class="sd">    sourceArea : array like</span>
<span class="sd">        The area of the source is required if `sourceType` is &quot;Both ears&quot; in</span>
<span class="sd">        which case `sourceAre` is a list with two values or if `sourceType` is</span>
<span class="sd">        &quot;Left ear&quot; or &quot;Right ear&quot; in which case `sourceArea` is a list with one</span>
<span class="sd">        value.</span>
<span class="sd">    speedOfSound : number</span>
<span class="sd">        The speed of sound in m/s</span>
<span class="sd">    densityOfAir : number</span>
<span class="sd">        The density of air in kg / m**3</span>
<span class="sd">    mode : str, optional</span>
<span class="sd">        Pass &quot;min&quot;, &quot;max&quot;, or &quot;mean&quot; to reference to the minmum, maximum, or</span>
<span class="sd">        mean radius in `sofa.SourcePosition`. Pass &quot;all&quot; to normalize each</span>
<span class="sd">        HRTF to the radius of the corresponding source.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sofa : sofar Sofa.object</span>
<span class="sd">        A copy of the input data with referenced sound pressure</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sofa</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">sofa</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">read_sofa</span><span class="p">(</span><span class="n">sofa</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sofa</span> <span class="o">=</span> <span class="n">sofa</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">sofa</span><span class="o">.</span><span class="n">GLOBAL_SOFAConventions</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SimpleFreeFieldHRTF&quot;</span><span class="p">,</span> <span class="s2">&quot;GeneralTF&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Sofa object must have the conventions &quot;</span>
                          <span class="s2">&quot;SimpleFreeFieldHRTF or GeneralTF&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">sofa</span><span class="o">.</span><span class="n">SourcePosition_Type</span> <span class="o">==</span> <span class="s2">&quot;spherical&quot;</span><span class="p">:</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">sofa</span><span class="o">.</span><span class="n">SourcePosition</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sofa</span><span class="o">.</span><span class="n">SourcePosition</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                         <span class="n">sofa</span><span class="o">.</span><span class="n">SourcePosition</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                         <span class="n">sofa</span><span class="o">.</span><span class="n">SourcePosition</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">pressure</span> <span class="o">=</span> <span class="n">sofa</span><span class="o">.</span><span class="n">Data_Real</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">sofa</span><span class="o">.</span><span class="n">Data_Imag</span>
    <span class="n">frequencies</span> <span class="o">=</span> <span class="n">sofa</span><span class="o">.</span><span class="n">N</span>

    <span class="c1"># distance of source positions from the origin</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">radius</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">sourceType</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;Both ears&#39;</span><span class="p">,</span> <span class="s1">&#39;Left ear&#39;</span><span class="p">,</span> <span class="s1">&#39;Right ear&#39;</span><span class="p">}:</span>

        <span class="n">volumeFlow</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">pressure</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;sourceArea&#39;</span><span class="p">:</span>
            <span class="c1"># has to be fixed for both ears....</span>
            <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sourceArea</span><span class="p">)):</span>
                <span class="n">volumeFlow</span><span class="p">[:,</span> <span class="n">nn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
                    <span class="n">volumeFlow</span><span class="p">[:,</span> <span class="n">nn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">sourceArea</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>

        <span class="c1"># point source in the origin evaluated at r</span>
        <span class="c1"># eq. (6.71) in: Williams, E. G. (1999). Fourier Acoustics.</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">densityOfAir</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">frequencies</span> <span class="o">*</span> \
            <span class="n">volumeFlow</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">frequencies</span> <span class="o">/</span> <span class="n">speedOfSound</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span>

    <span class="k">elif</span> <span class="n">sourceType</span> <span class="o">==</span> <span class="s1">&#39;Point source&#39;</span><span class="p">:</span>

        <span class="n">amplitude</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># hard coded in Mesh2HRTF</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">frequencies</span> <span class="o">/</span>
                   <span class="n">speedOfSound</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">sourceType</span> <span class="o">==</span> <span class="s1">&#39;Plane wave&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;Plane wave not implemented yet.&quot;</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;Referencing is currently only implemented for &quot;</span>
                <span class="s2">&quot;sourceType &#39;Both ears&#39;, &#39;Left ear&#39;, &#39;Right ear&#39;,&quot;</span>
                <span class="s2">&quot;&#39;Point source&#39; and &#39;Plane wave&#39;.&quot;</span><span class="p">))</span>

    <span class="c1"># here we go...</span>
    <span class="n">pressure</span> <span class="o">/=</span> <span class="n">ps</span>
    <span class="n">sofa</span><span class="o">.</span><span class="n">Data_Real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
    <span class="n">sofa</span><span class="o">.</span><span class="n">Data_Imag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sofa</span></div>


<div class="viewcode-block" id="compute_HRIR"><a class="viewcode-back" href="../../../../mesh2hrtf.html#mesh2hrtf.compute_HRIR">[docs]</a><span class="k">def</span> <span class="nf">compute_HRIR</span><span class="p">(</span><span class="n">sofa</span><span class="p">,</span> <span class="n">n_shift</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute HRIR from HRTF by means of the inverse Fourier transform.</span>

<span class="sd">    This requires the following:</span>

<span class="sd">    1. The HRTFs contained in `sofa` have been referenced using</span>
<span class="sd">       `reference_HRTFs()`.</span>
<span class="sd">    2. HRTF must be available for frequencies f_0 to f_1 in constant steps.</span>
<span class="sd">       f_0 must be &gt; 0 Hz and f_1 is assumed to be half the sampling rate.</span>

<span class="sd">    HRIRs are computed with the following steps</span>

<span class="sd">    1. Add data for 0 Hz. The HRTF at 0 Hz is 1 (0 dB) by definition because</span>
<span class="sd">       the HRTF describes the filtering of incoming sound by the human</span>
<span class="sd">       anthropometry (which does not change the sound at 0 Hz).</span>
<span class="sd">    2. Only the absolute value for the data at half the sampling rate is used.</span>
<span class="sd">       Otherwise the next step would produce complex output</span>
<span class="sd">    3. The HRTF spectrum is mirrored and the HRIR is obtained through the</span>
<span class="sd">       inverse Fourier transform</span>
<span class="sd">    4. The HRIRs are circularly shifted by `n_shift` samples to enforce a</span>
<span class="sd">       causal system. A good shift value for a sampling rate of 44.1 kHz might</span>
<span class="sd">       be between 20 and 40 samples.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sofa : sofar Sofa object, str</span>
<span class="sd">       Sofa object containing the sound pressure or filename of a SOFA file to</span>
<span class="sd">       be loaded. SOFA object/file must be of the convention</span>
<span class="sd">       SimpleFreeFieldHRTF or GeneralTF</span>
<span class="sd">    n_shift : int</span>
<span class="sd">        Amount the HRIRs are shifted to enforce a causal system.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sofa : sofar Sofa.object</span>
<span class="sd">        HRIRs</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    HRIRs for different sampling rates can be generated from a single SOFA file</span>
<span class="sd">    if discarding or adding some data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sofa</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">sofa</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">read_sofa</span><span class="p">(</span><span class="n">sofa</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sofa</span> <span class="o">=</span> <span class="n">sofa</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">sofa</span><span class="o">.</span><span class="n">GLOBAL_SOFAConventions</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SimpleFreeFieldHRTF&quot;</span><span class="p">,</span> <span class="s2">&quot;GeneralTF&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Sofa object must have the conventions &quot;</span>
                          <span class="s2">&quot;SimpleFreeFieldHRTF or GeneralTF&quot;</span><span class="p">))</span>

    <span class="c1"># check if the frequency vector has the correct format</span>
    <span class="n">frequencies</span> <span class="o">=</span> <span class="n">sofa</span><span class="o">.</span><span class="n">N</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">.1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">frequencies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">.1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;The frequency vector must go from f_1 &gt; 0 to&#39;</span>
             <span class="s1">&#39;f_2 (half the sampling rate) in equidistant steps.&#39;</span><span class="p">))</span>

    <span class="n">pressure</span> <span class="o">=</span> <span class="n">sofa</span><span class="o">.</span><span class="n">Data_Real</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">sofa</span><span class="o">.</span><span class="n">Data_Imag</span>

    <span class="n">fs</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">frequencies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># add 0 Hz bin</span>
    <span class="n">pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">pressure</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">pressure</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">pressure</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># make fs/2 real</span>
    <span class="n">pressure</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pressure</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># ifft (take complex conjugate because sign conventions differ)</span>
    <span class="n">hrir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">pressure</span><span class="p">))</span>

    <span class="c1"># shift to make causal</span>
    <span class="c1"># (path differences between the origin and the ear are usually</span>
    <span class="c1"># smaller than 30 cm but numerical HRIRs show stringer pre-ringing)</span>
    <span class="n">hrir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">hrir</span><span class="p">,</span> <span class="n">n_shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">sofa</span> <span class="o">=</span> <span class="n">_get_sofa_object</span><span class="p">(</span>
        <span class="n">hrir</span><span class="p">,</span> <span class="n">sofa</span><span class="o">.</span><span class="n">SourcePosition</span><span class="p">,</span> <span class="n">sofa</span><span class="o">.</span><span class="n">SourcePosition_Type</span><span class="p">,</span>
        <span class="n">sofa</span><span class="o">.</span><span class="n">ReceiverPosition</span><span class="p">,</span> <span class="s2">&quot;HRIR&quot;</span><span class="p">,</span> <span class="n">sofa</span><span class="o">.</span><span class="n">GLOBAL_ApplicationVersion</span><span class="p">,</span>
        <span class="n">sampling_rate</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sofa</span></div>


<div class="viewcode-block" id="inspect_sofa_files"><a class="viewcode-back" href="../../../../mesh2hrtf.html#mesh2hrtf.inspect_sofa_files">[docs]</a><span class="k">def</span> <span class="nf">inspect_sofa_files</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plane</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
                       <span class="n">atol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">savedir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inspect SOFA files through plots.</span>

<span class="sd">    Generate and save plots for horizontal plane HRIRs (time domain) and HRTFs</span>
<span class="sd">    (frequency domain) for one or multiple SOFA files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    folder : str</span>
<span class="sd">        Name of a folder. SOFA files are searched in folder/Output2HRTF if it</span>
<span class="sd">        exist and directly in `folder` otherwise.</span>

<span class="sd">        The name may contain an asterisk to process data in multiple folders.</span>
<span class="sd">        E.g., if `folder` is ``&quot;some/path/HRIRs_*&quot;`` files in all folder</span>
<span class="sd">        starting with &quot;HRIRs&quot; would be scanned for SOFA files.</span>
<span class="sd">    pattern : str</span>
<span class="sd">        Merge only files that contain `pattern` in their filename. The default</span>
<span class="sd">        ``None`` merges all SOFA files.</span>
<span class="sd">    plot : str, optional</span>
<span class="sd">        ``&quot;2D&quot;``</span>
<span class="sd">            generate line plots of four sources on the horizontal plane</span>
<span class="sd">            (front, back, left, right). The closest sources to the ideal</span>
<span class="sd">            positoins are used for plotting.</span>
<span class="sd">        ``&quot;3D&quot;``</span>
<span class="sd">            generate color coded plots of all sources on the horizontal</span>
<span class="sd">            plane. See also parameter `atol` below.</span>

<span class="sd">        The default ``None`` generate both plots.</span>
<span class="sd">    plane : str, optional</span>
<span class="sd">        Select the plane for which is shown in the 3D plot. Can be</span>
<span class="sd">        ``&quot;horizontal&quot;`` (default), ``&quot;median&quot;``, or ``&quot;frontal&quot;``</span>
<span class="sd">    atol : float, optional</span>
<span class="sd">        Sources on the `plane` are searched within a range +/- `atol` degree.</span>
<span class="sd">        The default is ``0.1``.</span>
<span class="sd">    savedir : str</span>
<span class="sd">        Directory for saving the merged SOFA files. The default ``None`` saves</span>
<span class="sd">        the files to the directory given by `folder`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check input</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;2D&quot;</span><span class="p">,</span> <span class="s2">&quot;3D&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">plot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;2D&quot;</span><span class="p">,</span> <span class="s2">&quot;3D&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;plot is </span><span class="si">{</span><span class="n">plot</span><span class="si">}</span><span class="s2"> but must be 2D, 3D, or all&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plane</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span> <span class="s2">&quot;frontal&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;plane is </span><span class="si">{</span><span class="n">plane</span><span class="si">}</span><span class="s2"> but must be horizontal, median, or frontal&quot;</span><span class="p">)</span>

    <span class="c1"># get all directories containing SOFA files</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="c1"># loop directories</span>
    <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>

        <span class="c1"># check if Output2HRTF folder exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;Output2HRTF&quot;</span><span class="p">)):</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;Output2HRTF&quot;</span><span class="p">)</span>

        <span class="c1"># find matching SOFA files</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;*.sofa&quot;</span> <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">*.sofa&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">pattern</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;Did not find any SOFA files in </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;that are matching *</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">*.sofa&quot;</span><span class="p">))</span>

        <span class="c1"># loop and inspect all SOFA files</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">savedir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">savedir</span> <span class="o">=</span> <span class="n">folder</span>

            <span class="c1"># inspect data</span>
            <span class="n">_inspect_sofa_files</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">savedir</span><span class="p">,</span> <span class="n">atol</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">plane</span><span class="p">)</span></div>


<div class="viewcode-block" id="merge_sofa_files"><a class="viewcode-back" href="../../../../mesh2hrtf.html#mesh2hrtf.merge_sofa_files">[docs]</a><span class="k">def</span> <span class="nf">merge_sofa_files</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savedir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge HRTFs and HRIRs from SOFA-files containing left and right ear data.</span>

<span class="sd">    The names of the merged SOFA files and with the &quot;merged.sofa&quot;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    left, right : str</span>
<span class="sd">        `left` and `right` are folder names. SOFA files are searched in</span>
<span class="sd">        folder/Output2HRTF if it exist and directly in `folder` otherwise.</span>

<span class="sd">        The names may contain an asterisk to process data in multiple folders.</span>
<span class="sd">        E.g., if `left` is ``&quot;some/path/*_left&quot;`` and `right` is</span>
<span class="sd">        ``&quot;some/path/*_right&quot;`` all SOFA files in the matching folders will be</span>
<span class="sd">        merged. Note that the Output2HRTF folder pairs given by `left` and</span>
<span class="sd">        `right` must contain SOFA files with identical names.</span>
<span class="sd">    pattern : str</span>
<span class="sd">        Merge only files that contain `pattern` in their filename. The default</span>
<span class="sd">        ``None`` merges all SOFA files.</span>
<span class="sd">    savedir : str</span>
<span class="sd">        Directory for saving the merged SOFA files. The default ``None`` saves</span>
<span class="sd">        the files to the directory given by `left`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">savedir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">savedir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;savedir </span><span class="si">{</span><span class="n">savedir</span><span class="si">}</span><span class="s2"> is not a directory&quot;</span><span class="p">)</span>

    <span class="c1"># get all search directories</span>
    <span class="n">left_dirs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
    <span class="n">right_dirs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_dirs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_dirs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;The number of directories found with glob.glob()&quot;</span>
                          <span class="sa">f</span><span class="s2">&quot; does not match for </span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="c1"># loop directories</span>
    <span class="k">for</span> <span class="n">left_dir</span><span class="p">,</span> <span class="n">right_dir</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">left_dirs</span><span class="p">,</span> <span class="n">right_dirs</span><span class="p">):</span>

        <span class="c1"># check if Output2HRTF folder exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">left_dir</span><span class="p">,</span> <span class="s2">&quot;Output2HRTF&quot;</span><span class="p">))</span> \
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right_dir</span><span class="p">,</span> <span class="s2">&quot;Output2HRTF&quot;</span><span class="p">)):</span>
            <span class="n">left_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">left_dir</span><span class="p">,</span> <span class="s2">&quot;Output2HRTF&quot;</span><span class="p">)</span>
            <span class="n">right_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right_dir</span><span class="p">,</span> <span class="s2">&quot;Output2HRTF&quot;</span><span class="p">)</span>

        <span class="c1"># check which data to merge</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;*.sofa&quot;</span> <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">*.sofa&quot;</span>

        <span class="c1"># get and check all SOFA files in Output2HRTF folder</span>
        <span class="n">left_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">left_dir</span><span class="p">,</span> <span class="n">pattern</span><span class="p">))</span>
        <span class="n">right_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right_dir</span><span class="p">,</span> <span class="n">pattern</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_files</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span>
                <span class="s2">&quot;The umber of sofa files found with glob.glob()&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; does not match for </span><span class="si">{</span><span class="n">left_dir</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">right_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

        <span class="c1"># loop all SOFA files</span>
        <span class="k">for</span> <span class="n">left_file</span><span class="p">,</span> <span class="n">right_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">left_files</span><span class="p">,</span> <span class="n">right_files</span><span class="p">):</span>

            <span class="c1"># check file names</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">left_file</span><span class="p">)</span>
                    <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">right_file</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span>
                    <span class="s2">&quot;Found mismatching. Each Output2HRTF folder must &quot;</span>
                    <span class="s2">&quot;contain SOFA files with the same names. Error for&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">left_file</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">right_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

            <span class="c1"># filename of merged data</span>
            <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">left_file</span><span class="p">)</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;.sofa&quot;</span><span class="p">)]</span> <span class="o">+</span> <span class="s2">&quot;_merged.sofa&quot;</span>

            <span class="k">if</span> <span class="n">savedir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">head</span> <span class="o">=</span> <span class="n">savedir</span>

            <span class="c1"># merge data</span>
            <span class="n">_merge_sofa_files</span><span class="p">(</span><span class="n">left_file</span><span class="p">,</span> <span class="n">right_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">))</span></div>


<div class="viewcode-block" id="project_report"><a class="viewcode-back" href="../../../../mesh2hrtf.html#mesh2hrtf.project_report">[docs]</a><span class="k">def</span> <span class="nf">project_report</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze output files written by NumCalc, generate project report, and</span>
<span class="sd">    scan report for issues.</span>

<span class="sd">    NumCalc (Mesh2HRTF&#39;s numerical core) writes information about the</span>
<span class="sd">    simulations to the files `NC*.inp` located under `NumCalc/source_*`. The</span>
<span class="sd">    file `NC.inp` exists if NumCalc was ran without the additional command line</span>
<span class="sd">    parameters ``-istart`` and ``-iend``. If these parameters were used, there</span>
<span class="sd">    is at least one `NC\*-\*.inp`. If this is the case, information from</span>
<span class="sd">    `NC\*-\*.inp` overwrites information from NC.inp in the project report.</span>

<span class="sd">    .. note::</span>

<span class="sd">        The project reports are written to the files</span>
<span class="sd">        `Output2HRTF/report_source_*.csv`. If issues were detected, they are</span>
<span class="sd">        listed in `Output2HRTF/report_issues.csv`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    folder : str, optional</span>
<span class="sd">        The path of the Mesh2HRTF project folder, i.e., the folder containing</span>
<span class="sd">        the subfolders EvaluationsGrids, NumCalc, and ObjectMeshes. The</span>
<span class="sd">        default, ``None`` uses the current working directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    found_issues : bool</span>
<span class="sd">        ``True`` if issues were found, ``False`` otherwise</span>
<span class="sd">    report : str</span>
<span class="sd">        The report or an empty string if no issues were found</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="c1"># get sources and number of sources and frequencies</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;NumCalc&quot;</span><span class="p">,</span> <span class="s2">&quot;source_*&quot;</span><span class="p">))</span>
    <span class="n">num_sources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
    <span class="n">num_frequencies</span> <span class="o">=</span> <span class="n">_get_number_of_frequencies</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;Info.txt&quot;</span><span class="p">))</span>

    <span class="c1"># parse all NC*.out files for all sources</span>
    <span class="n">all_files</span><span class="p">,</span> <span class="n">fundamentals</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">out_names</span> <span class="o">=</span> <span class="n">_parse_nc_out_files</span><span class="p">(</span>
        <span class="n">sources</span><span class="p">,</span> <span class="n">num_sources</span><span class="p">,</span> <span class="n">num_frequencies</span><span class="p">)</span>

    <span class="c1"># write report as csv file</span>
    <span class="n">_write_project_reports</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">all_files</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">out_names</span><span class="p">)</span>

    <span class="c1"># look for errors</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">_check_project_report</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">fundamentals</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

    <span class="n">found_issues</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">report</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">found_issues</span><span class="p">,</span> <span class="n">report</span></div>


<div class="viewcode-block" id="write_evaluation_grid"><a class="viewcode-back" href="../../../../mesh2hrtf.html#mesh2hrtf.write_evaluation_grid">[docs]</a><span class="k">def</span> <span class="nf">write_evaluation_grid</span><span class="p">(</span>
        <span class="n">points</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">200000</span><span class="p">,</span> <span class="n">discard</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write evaluation grid for use in Mesh2HRTF.</span>

<span class="sd">    Mesh2HRTF evaluation grids consist of the two text files Nodes.txt and</span>
<span class="sd">    Elements.txt. Evaluations grids are always triangularized.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points : pyfar Coordinates, numpy array</span>
<span class="sd">        pyfar Coordinates object or 2D numpy array containing the cartesian</span>
<span class="sd">        points of the evaluation grid in meter. The array must be of shape</span>
<span class="sd">        (N, 3) with N &gt; 2.</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of the folder under which the evaluation grid is saved. If the</span>
<span class="sd">        folder does not exist, it is created.</span>
<span class="sd">    start : int, optional</span>
<span class="sd">        The nodes and elements of the evaluation grid are numbered and the</span>
<span class="sd">        first element will have the number `start`. In Mesh2HRTF, each Node</span>
<span class="sd">        must have a unique number. The nodes/elements of the mesh for which the</span>
<span class="sd">        HRTFs are simulated start at 1. Thus `start` must at least be greater</span>
<span class="sd">        than the number of nodes/elements in the evaluation grid.</span>
<span class="sd">    discard : &quot;x&quot;, &quot;y&quot;, &quot;z&quot;, optional</span>
<span class="sd">        In case all values of the evaluation grid are constant for one</span>
<span class="sd">        dimension, this dimension has to be discarded during the</span>
<span class="sd">        triangularization. E.g. if all points have a z-value of 0 (or any other</span>
<span class="sd">        constant), discarded must be &quot;z&quot;. The default ``None`` does not discard</span>
<span class="sd">        any dimension.</span>
<span class="sd">    show : bool, optional</span>
<span class="sd">        If ``True`` the evaluation grid is plotted and the plot is saved to</span>
<span class="sd">        the folder given by `name`</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Generate a spherical sampling grid with pyfar and write it to the current</span>
<span class="sd">    working directory</span>

<span class="sd">    .. plot::</span>

<span class="sd">        &gt;&gt;&gt; import mesh2hrtf as m2h</span>
<span class="sd">        &gt;&gt;&gt; import pyfar as pf</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; points = pf.samplings.sph_lebedev(sh_order=10)</span>
<span class="sd">        &gt;&gt;&gt; m2h.write_evaluation_grid(</span>
<span class="sd">        ...     points, &quot;Lebedev_N10&quot;, discard=None, show=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pf</span><span class="o">.</span><span class="n">Coordinates</span><span class="p">):</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">get_cart</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span> \
            <span class="ow">or</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;points must be a 2D array of shape (N, 3) with N &gt; 2&quot;</span><span class="p">)</span>

    <span class="c1"># discard dimension</span>
    <span class="k">if</span> <span class="n">discard</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">discard</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">discard</span> <span class="o">==</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># triangulate</span>
    <span class="k">if</span> <span class="n">discard</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tri</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tri</span> <span class="o">=</span> <span class="n">Delaunay</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">])</span>

    <span class="c1"># check output directory</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># write nodes</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

    <span class="n">nodes</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">nodes</span> <span class="o">+=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">nn</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">points</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">points</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">points</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;Nodes.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_id</span><span class="p">:</span>
        <span class="n">f_id</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

    <span class="c1"># write elements</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tri</span><span class="o">.</span><span class="n">simplices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">elems</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">elems</span> <span class="o">+=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">nn</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tri</span><span class="o">.</span><span class="n">simplices</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">start</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tri</span><span class="o">.</span><span class="n">simplices</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">start</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tri</span><span class="o">.</span><span class="n">simplices</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">start</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="s2">&quot;2 0 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;Elements.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_id</span><span class="p">:</span>
        <span class="n">f_id</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>

    <span class="c1"># plot the evaluation grid</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">Coordinates</span><span class="p">(</span>
            <span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;evaluation_grid.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_evaluation_grid"><a class="viewcode-back" href="../../../../mesh2hrtf.html#mesh2hrtf.read_evaluation_grid">[docs]</a><span class="k">def</span> <span class="nf">read_evaluation_grid</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read Mesh2HRTF evaluation grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of the folder containing the nodes of the evaluation grid in</span>
<span class="sd">        Nodes.txt</span>
<span class="sd">    show : bool, optional</span>
<span class="sd">        If ``True`` the points of the evaluation grid are plotted. The default</span>
<span class="sd">        is ``False``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    coordinates : pyfar Coordinates</span>
<span class="sd">        The points of the evaluation grid as a pyfar Coordinates object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check if the grid exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;Nodes.txt&quot;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Nodes.txt&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>

    <span class="c1"># read the nodes</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;Nodes.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_id</span><span class="p">:</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">f_id</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="c1"># get number of nodes</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="c1"># get points (first entry is node number)</span>
    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">nn</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">points</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">points</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">points</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># make coordinates object</span>
    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">Coordinates</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>

    <span class="c1"># plot and return</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">coordinates</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">coordinates</span></div>


<div class="viewcode-block" id="export_to_vtk"><a class="viewcode-back" href="../../../../mesh2hrtf.html#mesh2hrtf.export_to_vtk">[docs]</a><span class="k">def</span> <span class="nf">export_to_vtk</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">object_mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frequency_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">dB</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log_prefix</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">log_reference</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export pressure on the (head) mesh to vtk files for importing in ParaView</span>

<span class="sd">    The exported vtk files are written to folder/Output2HRTF/Reference_vtk</span>
<span class="sd">    where &#39;Reference&#39; is given by `object_mesh`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    folder : str, optional</span>
<span class="sd">        The Mesh2HRTF project folder. The default ``None`` uses the current</span>
<span class="sd">        folder</span>
<span class="sd">    object_mesh : str, optional</span>
<span class="sd">        The name of the mesh for which the pressure is exported. The default</span>
<span class="sd">        ``None`` selects the `Reference` mesh.</span>
<span class="sd">    frequency_steps : list, optional</span>
<span class="sd">        List with first and last frequency step for which the data is</span>
<span class="sd">        exported. The default ``None`` exports the data for all frequency</span>
<span class="sd">        steps.</span>
<span class="sd">    dB : bool, optional</span>
<span class="sd">        Save pressure in dB if ``True`` (default) and linear otherwise.</span>
<span class="sd">    log_prefix, log_reference : number, optional</span>
<span class="sd">        The pressure in dB is calculated as</span>
<span class="sd">        ``log_prefix * log_10(pressure/log_reference)``. The default values</span>
<span class="sd">        are ``20`` and ``1``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check input data</span>
    <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">object_mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">object_mesh</span> <span class="o">=</span> <span class="s2">&quot;Reference&quot;</span>

    <span class="c1"># load object mesh data</span>
    <span class="n">object_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;Output2HRTF&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ObjectMesh_</span><span class="si">{</span><span class="n">object_mesh</span><span class="si">}</span><span class="s2">.npz&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">object_name</span><span class="p">):</span>
        <span class="c1"># contains: frequencies and pressure</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">pressure</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">object_name</span><span class="si">}</span><span class="s2"> does not exist. &quot;</span>
                          <span class="s2">&quot;Run Output2HRTF_Main to create it&quot;</span><span class="p">))</span>

    <span class="c1"># convert pressure to dB</span>
    <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="n">pressure</span> <span class="o">=</span> <span class="n">log_prefix</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span><span class="o">/</span><span class="n">log_reference</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>

        <span class="n">amp_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log_prefix</span><span class="si">}</span><span class="s2">log(pressure/</span><span class="si">{</span><span class="n">log_reference</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">file_str</span> <span class="o">=</span> <span class="s2">&quot;db&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">amp_str</span> <span class="o">=</span> <span class="s2">&quot;pressure&quot;</span>
        <span class="n">file_str</span> <span class="o">=</span> <span class="s2">&quot;lin&quot;</span>

    <span class="c1"># load object mesh</span>
    <span class="n">grid</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_read_nodes_and_elements</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;ObjectMeshes&#39;</span><span class="p">))</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">object_mesh</span><span class="p">][</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">object_mesh</span><span class="p">][</span><span class="s2">&quot;elements&quot;</span><span class="p">]</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">object_mesh</span><span class="p">][</span><span class="s2">&quot;num_nodes&quot;</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">grid</span>

    <span class="c1"># create output folder</span>
    <span class="n">savedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;Output2HRTF&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">object_mesh</span><span class="si">}</span><span class="s2">_vtk&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">savedir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savedir</span><span class="p">)</span>

    <span class="c1"># parse frequency steps</span>
    <span class="k">if</span> <span class="n">frequency_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">frequency_steps</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">frequencies</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frequency_steps</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frequency_steps</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> \
            <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frequency_steps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">frequencies</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;frequency_steps must contain two values between 1 &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;and </span><span class="si">{</span><span class="n">frequencies</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="c1"># write constant part of the vtk file</span>
    <span class="n">vtk</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;# vtk DataFile Version 3.0</span><span class="se">\n</span><span class="s2">&quot;</span>
           <span class="s2">&quot;Mesh2HRTF Files</span><span class="se">\n</span><span class="s2">&quot;</span>
           <span class="s2">&quot;ASCII</span><span class="se">\n</span><span class="s2">&quot;</span>
           <span class="s2">&quot;DATASET POLYDATA</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># write nodes</span>
    <span class="n">vtk</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;POINTS </span><span class="si">{</span><span class="n">num_nodes</span><span class="si">}</span><span class="s2"> float</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">nodes_txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">):</span>
        <span class="n">nodes_txt</span> <span class="o">+=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nodes</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2"> .4f</span><span class="si">}</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nodes</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2"> .4f</span><span class="si">}</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nodes</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="s2"> .4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">vtk</span> <span class="o">+=</span> <span class="n">nodes_txt</span>

    <span class="c1"># write elements</span>
    <span class="n">vtk</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;POLYGONS </span><span class="si">{</span><span class="n">elements</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">elements</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">elements_txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">elements</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">elements_txt</span> <span class="o">+=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;3 </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2"> &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span><span class="si">}</span><span class="s2"> &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">vtk</span> <span class="o">+=</span> <span class="n">elements_txt</span>

    <span class="n">vtk</span> <span class="o">+=</span> <span class="s2">&quot;CELL_DATA 2412</span><span class="se">\n\n</span><span class="s2">&quot;</span>

    <span class="c1"># write vtk files</span>
    <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">frequency_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">frequency_steps</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

        <span class="n">pressure_txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pressure</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">pressure_txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;SCALARS </span><span class="si">{</span><span class="n">amp_str</span><span class="si">}</span><span class="s2">-source_</span><span class="si">{</span><span class="n">ss</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2"> float 1</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">pressure_txt</span> <span class="o">+=</span> <span class="s2">&quot;LOOKUP_TABLE default</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pressure</span><span class="p">[:,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ff</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">:</span>
                <span class="n">pressure_txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">pressure_txt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">vtk_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">savedir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_str</span><span class="si">}</span><span class="s2">_frequency_step_</span><span class="si">{</span><span class="n">ff</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">.vtk&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vtk_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vtk</span> <span class="o">+</span> <span class="n">pressure_txt</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_parse_nc_out_files</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">num_sources</span><span class="p">,</span> <span class="n">num_frequencies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse all NC*.out files for all sources.</span>

<span class="sd">    This function should never raise a value error, regardless of how mess</span>
<span class="sd">    NC*.out files are. Looking for error is done at a later step.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sources : list of strings</span>
<span class="sd">        full path to the source folders</span>
<span class="sd">    num_sources : int</span>
<span class="sd">        number of sources - len(num_sources)</span>
<span class="sd">    num_frequencies : int</span>
<span class="sd">        number of frequency steps</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : numpy array</span>
<span class="sd">        containing the extracted information for each frequency step</span>
<span class="sd">    out_names : list of string</span>
<span class="sd">        verbal information about the columns of `out`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># array for reporting fundamental errors</span>
    <span class="n">fundamentals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># array for saving the detailed report</span>
    <span class="n">out_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;frequency step&quot;</span><span class="p">,</span>         <span class="c1"># 0</span>
                 <span class="s2">&quot;frequency in Hz&quot;</span><span class="p">,</span>        <span class="c1"># 1</span>
                 <span class="s2">&quot;NC input file&quot;</span><span class="p">,</span>          <span class="c1"># 2</span>
                 <span class="s2">&quot;Input check passed&quot;</span><span class="p">,</span>     <span class="c1"># 3</span>
                 <span class="s2">&quot;Converged&quot;</span><span class="p">,</span>              <span class="c1"># 4</span>
                 <span class="s2">&quot;Num. iterations&quot;</span><span class="p">,</span>        <span class="c1"># 5</span>
                 <span class="s2">&quot;relative error&quot;</span><span class="p">,</span>         <span class="c1"># 6</span>
                 <span class="s2">&quot;Comp. time total&quot;</span><span class="p">,</span>       <span class="c1"># 7</span>
                 <span class="s2">&quot;Comp. time assembling&quot;</span><span class="p">,</span>  <span class="c1"># 8</span>
                 <span class="s2">&quot;Comp. time solving&quot;</span><span class="p">,</span>     <span class="c1"># 9</span>
                 <span class="s2">&quot;Comp. time post-proc.&quot;</span><span class="p">]</span>  <span class="c1"># 10</span>
    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">num_frequencies</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">num_sources</span><span class="p">))</span>
    <span class="c1"># values for steps</span>
    <span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_frequencies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="c1"># values indicating failed input check and non-convergence</span>
    <span class="n">out</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">out</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># regular expression for finding a number that can be int or float</span>
    <span class="n">re_number</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(\d+(?:\.\d+)?)&quot;</span>

    <span class="c1"># loop sources</span>
    <span class="k">for</span> <span class="n">ss</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">):</span>

        <span class="c1"># list of NC*.inp files for parsing</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s2">&quot;NC*.out&quot;</span><span class="p">))</span>

        <span class="c1"># make sure that NC.out is first</span>
        <span class="n">nc_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s2">&quot;NC.out&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nc_out</span> <span class="ow">in</span> <span class="n">files</span> <span class="ow">and</span> <span class="n">files</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nc_out</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nc_out</span><span class="p">))]</span> <span class="o">+</span> <span class="n">files</span>

        <span class="c1"># update fundamentals</span>
        <span class="n">fundamentals</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">))])</span>
        <span class="n">all_files</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">])</span>

        <span class="c1"># frequency steps simulated in each file</span>
        <span class="c1"># (code not needed and does not yet catch NCuntil*.inp and NCfrom*.inp)</span>
        <span class="c1"># steps = []</span>
        <span class="c1"># for file in files:</span>
        <span class="c1">#     parts = os.path.basename(file).split(&#39;-&#39;)</span>
        <span class="c1">#     if len(parts) == 1:</span>
        <span class="c1">#         steps.append([1, num_frequencies])</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         steps.append([int(parts[0][2:]), int(parts[1][:-4])])</span>

        <span class="c1"># get content from all NC*.inp</span>
        <span class="k">for</span> <span class="n">ff</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>

            <span class="c1"># read the file and join all lines</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_id</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f_id</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

            <span class="c1"># split header and steps</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                <span class="s2">&quot;&gt;&gt; S T E P   N U M B E R   A N D   F R E Q U E N C Y &lt;&lt;&quot;</span><span class="p">)</span>

            <span class="c1"># look for fundamental errors</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fundamentals</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="c1"># parse frequencies (skip header)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>

                <span class="c1"># find frequency step</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Step \d+,&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">+</span><span class="mi">5</span><span class="p">:</span><span class="n">idx</span><span class="o">.</span><span class="n">end</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="c1"># write number of input file (replaced by string later)</span>
                <span class="n">out</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span>

                <span class="c1"># find frequency</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Frequency = </span><span class="si">{</span><span class="n">re_number</span><span class="si">}</span><span class="s1"> Hz&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                        <span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">+</span><span class="mi">12</span><span class="p">:</span><span class="n">idx</span><span class="o">.</span><span class="n">end</span><span class="p">()</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>

                <span class="c1"># check if the input data was ok</span>
                <span class="k">if</span> <span class="s2">&quot;Too many integral points in the theta&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># check and write convergence</span>
                <span class="k">if</span> <span class="s1">&#39;Maximum number of iterations is reached!&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># check iterations</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;number of iterations = \d+,&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">+</span><span class="mi">23</span><span class="p">:</span><span class="n">idx</span><span class="o">.</span><span class="n">end</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="c1"># check relative error</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;relative error = .+&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">+</span><span class="mi">17</span><span class="p">:</span><span class="n">idx</span><span class="o">.</span><span class="n">end</span><span class="p">()])</span>

                <span class="c1"># check time stats</span>
                <span class="c1"># -- assembling</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s1">&#39;Assembling the equation system         : \d+&#39;</span><span class="p">,</span>
                    <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">+</span><span class="mi">41</span><span class="p">:</span><span class="n">idx</span><span class="o">.</span><span class="n">end</span><span class="p">()])</span>

                <span class="c1"># -- solving</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s1">&#39;Solving the equation system            : \d+&#39;</span><span class="p">,</span>
                    <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">+</span><span class="mi">41</span><span class="p">:</span><span class="n">idx</span><span class="o">.</span><span class="n">end</span><span class="p">()])</span>

                <span class="c1"># -- post-pro</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s1">&#39;Post processing                        : \d+&#39;</span><span class="p">,</span>
                    <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">+</span><span class="mi">41</span><span class="p">:</span><span class="n">idx</span><span class="o">.</span><span class="n">end</span><span class="p">()])</span>

                <span class="c1"># -- total</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s1">&#39;Total                                  : \d+&#39;</span><span class="p">,</span>
                    <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">+</span><span class="mi">41</span><span class="p">:</span><span class="n">idx</span><span class="o">.</span><span class="n">end</span><span class="p">()])</span>

    <span class="k">return</span> <span class="n">all_files</span><span class="p">,</span> <span class="n">fundamentals</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">out_names</span>


<span class="k">def</span> <span class="nf">_write_project_reports</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">all_files</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">out_names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write project report to disk at folder/Output2HRTF/report_source_*.csv</span>

<span class="sd">    For description of input parameter refer to project_report and</span>
<span class="sd">    _parse_nc_out_files</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># loop sources</span>
    <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>

        <span class="n">report</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_names</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># loop frequencies</span>
        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:,</span> <span class="n">ss</span><span class="p">]</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>                <span class="c1"># frequency step</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>              <span class="c1"># frequency in Hz</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">all_files</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span><span class="si">}</span><span class="s2">,&quot;</span>  <span class="c1"># NC*.inp file</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>                <span class="c1"># input check</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>                <span class="c1"># convergence</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>                <span class="c1"># number of iterations</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>              <span class="c1"># relative error</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>                <span class="c1"># total computation time</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>                <span class="c1"># assembling equations time</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>                <span class="c1"># solving equations time</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>               <span class="c1"># post-processing time</span>
                <span class="p">)</span>

        <span class="c1"># write to disk</span>
        <span class="n">report_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;Output2HRTF&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;report_source_</span><span class="si">{</span><span class="n">ss</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_id</span><span class="p">:</span>
            <span class="n">f_id</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_project_report</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">fundamentals</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>

    <span class="c1"># return if there are no fundamental errors or other issues</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">all</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fundamentals</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]):</span>
        <span class="k">return</span>

    <span class="c1"># report detailed errors</span>
    <span class="n">report</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>

        <span class="c1"># currently we detect frequencies that were not calculated and</span>
        <span class="c1"># frequencies with convergence issues</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="s2">&quot;Frequency steps that were not calculated:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">input_test</span> <span class="o">=</span> <span class="s2">&quot;Frequency steps with bad input:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">convergence</span> <span class="o">=</span> <span class="s2">&quot;Frequency steps that did not converge:</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">any_missing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">any_input_failed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">any_convergence</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># loop frequencies</span>
        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">f</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:,</span> <span class="n">ss</span><span class="p">]</span>

            <span class="c1"># no value for frequency</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">any_missing</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">missing</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="k">continue</span>

            <span class="c1"># input data failed</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">any_input_failed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">input_test</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>

            <span class="c1"># convergence value is zero</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">any_convergence</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">convergence</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>

        <span class="k">if</span> <span class="n">any_missing</span> <span class="ow">or</span> <span class="n">any_input_failed</span> <span class="ow">or</span> <span class="n">any_convergence</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Detected issues for source </span><span class="si">{</span><span class="n">ss</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="s2">&quot;----------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">any_missing</span><span class="p">:</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="n">missing</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">any_input_failed</span><span class="p">:</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="n">input_test</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">any_convergence</span><span class="p">:</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="n">convergence</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="p">:</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Detected unknown issues</span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="s2">&quot;-----------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="s2">&quot;Check the project reports in Output2HRTF,</span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="s2">&quot;and the NC*.inp files in NumCalc/source_*</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">report</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;For more information check Output2HRTF/report_source_*.csv &quot;</span>
               <span class="s2">&quot;and the NC*.inp files located at NumCalc/source_*&quot;</span><span class="p">)</span>

    <span class="c1"># write to disk</span>
    <span class="n">report_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;Output2HRTF&quot;</span><span class="p">,</span> <span class="s2">&quot;report_issues.txt&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_id</span><span class="p">:</span>
        <span class="n">f_id</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">report</span>


<span class="k">def</span> <span class="nf">_inspect_sofa_files</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">savedir</span><span class="p">,</span> <span class="n">atol</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">plane</span><span class="p">):</span>

    <span class="k">with</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;NETCDF4&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sofa_file</span><span class="p">:</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sofa_file</span><span class="p">,</span> <span class="s2">&quot;DataType&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;FIR&quot;</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;hrir&quot;</span>
    <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;TF&quot;</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;hrtf&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The DataType of </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2"> but must &#39;FIR&#39; or &#39;TF&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># load sofa file and source positions</span>
    <span class="n">signal</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_sofa</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;2D&quot;</span> <span class="ow">in</span> <span class="n">plot</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">pf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">context</span><span class="p">():</span>

            <span class="c1"># generate plot layout and axes</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;hrir&quot;</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="p">)</span>
                <span class="n">ax_time</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ax_freq</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">ax_freq</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="p">)</span>

            <span class="c1"># loop sources</span>
            <span class="k">for</span> <span class="n">nn</span><span class="p">,</span> <span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">270</span><span class="p">],</span>
                    <span class="p">[</span><span class="s2">&quot;front&quot;</span><span class="p">,</span> <span class="s2">&quot;back&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">])):</span>

                <span class="c1"># find current source</span>
                <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">find_nearest_k</span><span class="p">(</span>
                    <span class="n">az</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sph&#39;</span><span class="p">,</span> <span class="s1">&#39;top_elev&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">)</span>

                <span class="c1"># exact position for plotting</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">get_sph</span><span class="p">(</span><span class="s1">&#39;top_elev&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">+=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; (az. </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;el. </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2"> deg.)&quot;</span><span class="p">)</span>

                <span class="c1"># plot</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;hrir&quot;</span><span class="p">:</span>
                    <span class="n">pf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">time_freq</span><span class="p">(</span>
                        <span class="n">signal</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="p">[</span><span class="n">ax_time</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">ax_freq</span><span class="p">[</span><span class="n">nn</span><span class="p">]])</span>
                    <span class="n">ax_time</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">freq</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_freq</span><span class="p">[</span><span class="n">nn</span><span class="p">])</span>
                    <span class="n">ax_freq</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># format axis and legend</span>
            <span class="n">y_lim</span> <span class="o">=</span> <span class="n">ax_freq</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="n">ax_freq</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">,</span> <span class="n">y_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">cshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">ax_freq</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;left ear&quot;</span><span class="p">,</span> <span class="s2">&quot;right ear&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">signal</span><span class="o">.</span><span class="n">cshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">ax_freq</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ch. </span><span class="si">{</span><span class="n">cc</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">cshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

            <span class="c1"># save</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="n">tail</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_2D.pdf&quot;</span><span class="p">),</span>
                        <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;3D&quot;</span> <span class="ow">in</span> <span class="n">plot</span><span class="p">:</span>

        <span class="n">num_chanel</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">cshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">pf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">context</span><span class="p">():</span>

            <span class="c1"># generate plot layout and axes</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;hrir&quot;</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_chanel</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="p">,</span>
                                     <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">num_chanel</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                                     <span class="p">)</span>
                <span class="n">ax_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ax_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">ax_freq</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="n">num_chanel</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">num_chanel</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="p">)</span>
                <span class="n">ax_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">ax_freq</span><span class="p">)</span>

            <span class="c1"># find sources on the desired plane</span>
            <span class="k">if</span> <span class="n">plane</span> <span class="o">==</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">find_slice</span><span class="p">(</span><span class="s2">&quot;elevation&quot;</span><span class="p">,</span> <span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="p">)</span>
                <span class="n">angles</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">get_sph</span><span class="p">(</span><span class="s1">&#39;top_elev&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">)[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="s2">&quot;azimuth&quot;</span>
            <span class="k">elif</span> <span class="n">plane</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">find_slice</span><span class="p">(</span><span class="s2">&quot;lateral&quot;</span><span class="p">,</span> <span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="p">)</span>
                <span class="n">angles</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">get_sph</span><span class="p">(</span><span class="s1">&#39;side&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">)[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="s2">&quot;polar angle&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">find_slice</span><span class="p">(</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">atol</span><span class="p">)</span>
                <span class="n">angles</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">get_sph</span><span class="p">(</span><span class="s1">&#39;front&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">)[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="s2">&quot;theta&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">((</span>
                    <span class="s2">&quot;Did not find and sources on the horizontal plane for &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;within +/-</span><span class="si">{</span><span class="n">atol</span><span class="si">}</span><span class="s2"> deg. for </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
                <span class="k">return</span>

            <span class="c1"># plot titles</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;left ear&quot;</span><span class="p">,</span> <span class="s2">&quot;right ear&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">cshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> \
                <span class="k">else</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ch. </span><span class="si">{</span><span class="n">cc</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">cshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>

            <span class="c1"># loop sources</span>
            <span class="k">for</span> <span class="n">cc</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>

                <span class="c1"># plot time data</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;hrir&quot;</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">qm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">time_2d</span><span class="p">(</span>
                        <span class="n">signal</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">cc</span><span class="p">],</span> <span class="n">indices</span><span class="o">=</span><span class="n">angles</span><span class="p">,</span>
                        <span class="n">ax</span><span class="o">=</span><span class="n">ax_time</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">)</span>
                    <span class="n">ax_time</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                    <span class="c1"># set limits of time plot symmetric</span>
                    <span class="n">c_lim</span> <span class="o">=</span> <span class="n">qm</span><span class="o">.</span><span class="n">get_clim</span><span class="p">()</span>
                    <span class="n">c_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">c_lim</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">qm</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="n">c_lim</span><span class="p">,</span> <span class="n">c_lim</span><span class="p">)</span>

                <span class="c1"># plot frequency data</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">qm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">freq_2d</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">cc</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_freq</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span>
                                           <span class="n">indices</span><span class="o">=</span><span class="n">angles</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;hrir&quot;</span><span class="p">:</span>
                    <span class="n">ax_freq</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">angle</span><span class="si">}</span><span class="s2"> in degree&quot;</span><span class="p">)</span>
                    <span class="n">ax_time</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax_freq</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">ax_freq</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">angle</span><span class="si">}</span><span class="s2"> in degree&quot;</span><span class="p">)</span>

                <span class="n">c_lim</span> <span class="o">=</span> <span class="n">qm</span><span class="o">.</span><span class="n">get_clim</span><span class="p">()</span>
                <span class="n">c_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">c_lim</span><span class="p">))</span>
                <span class="n">qm</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="n">c_lim</span> <span class="o">-</span> <span class="mi">50</span><span class="p">,</span> <span class="n">c_lim</span><span class="p">)</span>

            <span class="c1"># save</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="n">tail</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_3D.pdf&quot;</span><span class="p">),</span>
                        <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_merge_sofa_files</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">savename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;read two sofa files, join the data, and save the result&quot;&quot;&quot;</span>

    <span class="n">left</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">read_sofa</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">read_sofa</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>

    <span class="c1"># join Data</span>
    <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">GLOBAL_DataType</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">):</span>

        <span class="c1"># check if data can be joined</span>
        <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">right</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">size</span> <span class="ow">or</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="n">right</span><span class="o">.</span><span class="n">N</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Number of frequencies or frequencies do not &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;agree for </span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

        <span class="c1"># join data</span>
        <span class="n">left</span><span class="o">.</span><span class="n">Data_Real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">Data_Real</span><span class="p">,</span> <span class="n">right</span><span class="o">.</span><span class="n">Data_Real</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">left</span><span class="o">.</span><span class="n">Data_Imag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">Data_Imag</span><span class="p">,</span> <span class="n">right</span><span class="o">.</span><span class="n">Data_Imag</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">left</span><span class="o">.</span><span class="n">GLOBAL_DataType</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;FIR&quot;</span><span class="p">):</span>

        <span class="c1"># check if data can be joined</span>
        <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">get_dimension</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">right</span><span class="o">.</span><span class="n">get_dimension</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="n">left</span><span class="o">.</span><span class="n">Data_SamplingRate</span> <span class="o">!=</span> <span class="n">right</span><span class="o">.</span><span class="n">Data_SamplingRate</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Number of samples or sampling rates do not&quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;agree for </span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

        <span class="c1"># join data</span>
        <span class="n">left</span><span class="o">.</span><span class="n">Data_IR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">Data_IR</span><span class="p">,</span> <span class="n">right</span><span class="o">.</span><span class="n">Data_IR</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">left</span><span class="o">.</span><span class="n">Data_Delay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">left</span><span class="o">.</span><span class="n">Data_IR</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Joining only works for DataTypes &#39;TF&#39; and &#39;FIR&#39;&quot;</span><span class="p">)</span>

    <span class="n">left</span><span class="o">.</span><span class="n">ReceiverPosition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">ReceiverPosition</span><span class="p">),</span>
         <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">ReceiverPosition</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># write joined data to disk</span>
    <span class="n">sf</span><span class="o">.</span><span class="n">write_sofa</span><span class="p">(</span><span class="n">savename</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_read_nodes_and_elements</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read the nodes and elements of the evaluation grids or object meshes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EvaluationGrids&#39;</span><span class="p">,</span> <span class="s1">&#39;ObjectMeshes&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data must be EvaluationGrids or ObjectMeshes!&#39;</span><span class="p">)</span>

    <span class="n">grids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">gridsList</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">gridsNumNodes</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">gridsList</span><span class="p">:</span>
        <span class="n">tmpNodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="s1">&#39;Nodes.txt&#39;</span><span class="p">),</span>
            <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">tmpElements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="s1">&#39;Elements.txt&#39;</span><span class="p">),</span>
            <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">grids</span><span class="p">[</span><span class="n">grid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="n">tmpNodes</span><span class="p">,</span>
            <span class="s2">&quot;elements&quot;</span><span class="p">:</span> <span class="n">tmpElements</span><span class="p">,</span>
            <span class="s2">&quot;num_nodes&quot;</span><span class="p">:</span> <span class="n">tmpNodes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

        <span class="n">gridsNumNodes</span> <span class="o">+=</span> <span class="n">grids</span><span class="p">[</span><span class="n">grid</span><span class="p">][</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">grids</span><span class="p">,</span> <span class="n">gridsNumNodes</span>


<span class="k">def</span> <span class="nf">_read_pressure</span><span class="p">(</span><span class="n">numSources</span><span class="p">,</span> <span class="n">numFrequencies</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read the sound pressure on the object meshes or evaluation grid.&quot;&quot;&quot;</span>
    <span class="n">pressure</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;pBoundary&#39;</span> <span class="ow">or</span> <span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;pEvalGrid&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data must be pBoundary or pEvalGrid!&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Loading </span><span class="si">%s</span><span class="s1"> data ...&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numSources</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Source </span><span class="si">%d</span><span class="s1"> ...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">tmpFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;NumCalc&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;source_</span><span class="si">{</span><span class="n">source</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;be.out&#39;</span><span class="p">)</span>
        <span class="n">tmpPressure</span><span class="p">,</span> <span class="n">frequencies</span> <span class="o">=</span> <span class="n">_output_to_hrtf_load</span><span class="p">(</span>
            <span class="n">tmpFilename</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">numFrequencies</span><span class="p">)</span>

        <span class="n">pressure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpPressure</span><span class="p">)</span>

    <span class="n">pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pressure</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">frequencies</span>


<span class="k">def</span> <span class="nf">_get_sofa_object</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">source_position</span><span class="p">,</span> <span class="n">source_position_type</span><span class="p">,</span>
                     <span class="n">receiver_position</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">Mesh2HRTF_version</span><span class="p">,</span>
                     <span class="n">frequencies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write complex pressure or impulse responses to a SOFA object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : numpy array</span>
<span class="sd">        The data as an array of shape (MRE)</span>
<span class="sd">    evaluation_grid : numpy array</span>
<span class="sd">        The evaluation grid in Cartesian coordinates as an array of shape (MC)</span>
<span class="sd">    receiver_position : numpy array</span>
<span class="sd">        The position of the receivers (ears) in Cartesian coordinates</span>
<span class="sd">    mode : str</span>
<span class="sd">        &quot;HRTF&quot; to save HRTFs, &quot;HRIR&quot; to save HRIRs</span>
<span class="sd">    Mesh2HRTF_version : str</span>
<span class="sd">    frequencies : numpy array</span>
<span class="sd">        The frequencies at which the HRTFs were calculated. Required if mode is</span>
<span class="sd">        &quot;HRTF&quot;</span>
<span class="sd">    sampling_rate :</span>
<span class="sd">        The sampling rate. Required if mode is &quot;HRIR&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sofa : sofar.Sofa object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get source coordinates in spherical convention</span>
    <span class="k">if</span> <span class="n">source_position_type</span> <span class="o">==</span> <span class="s2">&quot;cartesian&quot;</span><span class="p">:</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">source_position</span>

        <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">z_div_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">radius</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">elevation</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">z_div_r</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">180</span>
        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> \
            <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">180</span>

        <span class="n">source_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">azimuth</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
             <span class="n">elevation</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
             <span class="n">radius</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># get number of sources from data</span>
    <span class="n">numSources</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># create empty SOFA object</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;HRTF&quot;</span><span class="p">:</span>
        <span class="n">convention</span> <span class="o">=</span> <span class="s2">&quot;SimpleFreeFieldHRTF&quot;</span> <span class="k">if</span> <span class="n">numSources</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;GeneralTF&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">convention</span> <span class="o">=</span> <span class="s2">&quot;SimpleFreeFieldHRIR&quot;</span> <span class="k">if</span> <span class="n">numSources</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;GeneralFIR&quot;</span>

    <span class="n">sofa</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Sofa</span><span class="p">(</span><span class="n">convention</span><span class="p">)</span>

    <span class="c1"># write meta data</span>
    <span class="n">sofa</span><span class="o">.</span><span class="n">GLOBAL_ApplicationName</span> <span class="o">=</span> <span class="s1">&#39;Mesh2HRTF&#39;</span>
    <span class="n">sofa</span><span class="o">.</span><span class="n">GLOBAL_ApplicationVersion</span> <span class="o">=</span> <span class="n">Mesh2HRTF_version</span>
    <span class="n">sofa</span><span class="o">.</span><span class="n">GLOBAL_History</span> <span class="o">=</span> <span class="s2">&quot;numerically simulated data&quot;</span>

    <span class="c1"># Source and receiver data</span>
    <span class="n">sofa</span><span class="o">.</span><span class="n">SourcePosition</span> <span class="o">=</span> <span class="n">source_position</span>
    <span class="n">sofa</span><span class="o">.</span><span class="n">SourcePosition_Units</span> <span class="o">=</span> <span class="s2">&quot;degree, degree, meter&quot;</span>
    <span class="n">sofa</span><span class="o">.</span><span class="n">SourcePosition_Type</span> <span class="o">=</span> <span class="s2">&quot;spherical&quot;</span>

    <span class="n">sofa</span><span class="o">.</span><span class="n">ReceiverPosition</span> <span class="o">=</span> <span class="n">receiver_position</span>
    <span class="n">sofa</span><span class="o">.</span><span class="n">ReceiverPosition_Units</span> <span class="o">=</span> <span class="s2">&quot;meter&quot;</span>
    <span class="n">sofa</span><span class="o">.</span><span class="n">ReceiverPosition_Type</span> <span class="o">=</span> <span class="s2">&quot;cartesian&quot;</span>

    <span class="c1"># HRTF/HRIR data</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;HRTF&quot;</span><span class="p">:</span>
        <span class="n">sofa</span><span class="o">.</span><span class="n">Data_Real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">sofa</span><span class="o">.</span><span class="n">Data_Imag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">sofa</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">frequencies</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sofa</span><span class="o">.</span><span class="n">Data_IR</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">sofa</span><span class="o">.</span><span class="n">Data_SamplingRate</span> <span class="o">=</span> <span class="n">sampling_rate</span>
        <span class="n">sofa</span><span class="o">.</span><span class="n">Data_Delay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">sofa</span>


<span class="k">def</span> <span class="nf">_output_to_hrtf_load</span><span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">numFrequencies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load results of the BEM calculation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    foldername : string</span>
<span class="sd">        The folder from which the data is loaded. The data to be read is</span>
<span class="sd">        located in the folder be.out inside NumCalc/source_*</span>
<span class="sd">    filename : string</span>
<span class="sd">        The kind of data that is loaded</span>

<span class="sd">        pBoundary</span>
<span class="sd">            The sound pressure on the object mesh</span>
<span class="sd">        vBoundary</span>
<span class="sd">            The sound velocity on the object mesh</span>
<span class="sd">        pEvalGrid</span>
<span class="sd">            The sound pressure on the evaulation grid</span>
<span class="sd">        vEvalGrid</span>
<span class="sd">            The sound velocity on the evaluation grid</span>
<span class="sd">    numFrequencies : int</span>
<span class="sd">        the number of simulated frequencies</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data : numpy array</span>
<span class="sd">        Pressure or velocity values of shape (numFrequencies, numEntries)</span>
<span class="sd">    frequencies : numpy array</span>
<span class="sd">        The frequencies in Hz</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------------------check number of header and data lines---------------</span>

    <span class="n">idx1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">idx2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;be.1&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">skipinitialspace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">li</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">idx1</span> <span class="o">=</span> <span class="n">idx2</span>
                    <span class="n">idx2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">idx2</span> <span class="o">-</span> <span class="n">idx1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">numHeaderlines_BE</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">-</span> <span class="mi">2</span>
                        <span class="n">numDatalines</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
                        <span class="k">break</span>

    <span class="c1"># ------------------------------load data----------------------------------</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">numFrequencies</span><span class="p">,</span> <span class="n">numDatalines</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numFrequencies</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numFrequencies</span><span class="p">):</span>
        <span class="n">tmpData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;be.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">current_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">skipinitialspace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">line_num</span> <span class="o">&gt;</span> <span class="n">numHeaderlines_BE</span><span class="p">:</span>
                    <span class="n">tmpData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">complex</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">li</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">li</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>

        <span class="k">if</span> <span class="n">tmpData</span><span class="p">:</span>
            <span class="n">current_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;fe.out&#39;</span><span class="p">,</span> <span class="s1">&#39;fe.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;load&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">current_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">skipinitialspace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">line_num</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">tmpFrequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmpData</span>
            <span class="n">frequency</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpFrequency</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">frequency</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">frequency</span>


<span class="k">def</span> <span class="nf">_get_number_of_frequencies</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read number of simulated frequency steps from Info.txt</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        path of Info.txt</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    frequency_steps : int</span>
<span class="sd">        number of simulated frequency steps</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;Frequency Steps: &#39;</span>

    <span class="c1"># read info file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="c1"># find line containing the number of frequency steps</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">):])</span>


<span class="k">def</span> <span class="nf">_read_computation_time</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read compuation time</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : string</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    computation_time : numpy array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Number of frequency steps&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="n">nSteps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nSteps</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">idx1</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">)</span>
            <span class="n">idx2</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">5</span><span class="p">:</span><span class="n">idx2</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">idx1</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="n">idx2</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Hz&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx1</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">idx2</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Assembling the equation system  &#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Solving the equation system  &#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Post processing  &#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Total  &#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Address computation &#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
</pre></div>
            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <nav class="relbar">
    </nav>


      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

          <div class="sidebar-resize-handle"></div>

<h3><a href="../../../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../mesh2hrtf.html">Mesh2HRTF Python API</a></li>
</ul>

<hr class="docutils" />
<ul>
  <li class="toctree-l1"><a class="reference internal" href="../../../../genindex.html" accesskey="I">General Index</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../../py-modindex.html">Python Module Index</a></li>
</ul>
<div id="ethical-ad-placement"></div>
        </div>
      </div>
    <footer role="contentinfo">
      &#169; Copyright 2020, the Mesh2HRTF developers.
      Created using <a class="reference external" href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
      <a class="reference external" href="https://insipid-sphinx-theme.readthedocs.io/">Insipid Theme</a>.
    </footer>
    <div class="sidebar-resize-handle"></div>
    <div id="overlay"></div>
  </body>
</html>